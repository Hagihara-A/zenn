---
title: "å‹å®‰å…¨firestore"
emoji: "ğŸ’¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firebase", "typescript"]
published: true
---
firestoreã‚’Typescriptã§ä½¿ã†ã¨ãã«ã€å‹ã¤ã‹ãªã„ã®ã§å°‘ã—ã¯ã¾ã¨ã‚‚ãã†ãªæ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹ã€‚é•·ã„ã®ã§æœ€å¾Œã®ã¾ã¨ã‚ã ã‘èª­ã‚ã°OKã€‚

# firestoreã®å•é¡Œç‚¹
1. get()ã™ã‚‹ã¨å…¨ã¦`{[key: string]: any}`ã§è¿”ã£ã¦ãã‚‹
2. DateãŒå‹æ‰‹ã«å¤‰æ›ã•ã‚Œã‚‹
3. `firebase`ã¨`firebase-admin`ã§å‹ãŒå¾®å¦™ã«é•ã†ã®ã§ã‚¨ãƒ©ãƒ¼ã§ã‚‹

ä¸€ã¤ãšã¤å¯¾å¿œç­–ã‚’æ›¸ãã€‚

# 1: getã®è¿”ã‚Šå€¤ã‚’å‹ä»˜ã‘ã™ã‚‹
ã“ã‚Œã¯è‡ªåˆ†ã§ã‚­ãƒ£ã‚¹ãƒˆã™ã‚‹æ–¹æ³•ã¨ã€`withConverter`ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚‹ã€‚

## ã‚­ãƒ£ã‚¹ãƒˆã‚’ä½¿ã†
```ts
interface User {
  uid: string;
  address: string;
  age: number;
}
const getUserDoc = (uid: string) =>
    DB.doc(`user/${uid}`) as firebase.firestore.DocumentReference<User>;
```
ä¸€ç•ªç°¡å˜

## withConverterã‚’ä½¿ã†
ã¤ãã«`withConverter`

```ts
function assertUser(data: any): asserts data is User {
  const d = data as Partial<User>; // è£œå®Œã®ãŸã‚ã‚­ãƒ£ã‚¹ãƒˆ
  if (
    !(
      typeof d?.uid === "string" &&
      typeof d?.address === "string" &&
      typeof d?.age === "number"
    )
  ) {
    throw new Error("data is not User type");
  }
}

const userConverter: firebase.firestore.FirestoreDataConverter<User> = {
  fromFirestore(ss, op) {
    const data = ss.data(op);
    assertUser(data);
    return data;
  },
  toFirestore: (model: User) => model,
};

const getUserDoc = (uid: string) =>
  DB.doc(`user/${uid}`).withConverter(userConverter);
const userSS = await getUserDoc("uid2").get();
```

assertsã¨ã„ã†ã®ã¯[ã“ã‚Œ](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-7.html#assertion-functions)

ãƒ¡ãƒªãƒƒãƒˆ: å‹å®‰å…¨åº¦ï¼ˆï¼Ÿï¼‰ãŒã‚­ãƒ£ã‚¹ãƒˆã‚ˆã‚Šã¯é«˜ã„ã€‚

ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: assertsé–¢æ•°ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ›¸ãã®ãŒã ã‚‹ã„

## ã¾ã¨ã‚
ã©ã†ã›ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å­˜åœ¨ã—ãªã‹ã£ãŸã‚‰ã©ã“ã‹ã§ã‚¨ãƒ©ãƒ¼å‡ºã‚‹ã‹ã‚‰ã‚­ãƒ£ã‚¹ãƒˆã§ã„ã„æ°—ã‚‚ã™ã‚‹

# 2: DateãŒã ã‚‹ã„
ã¾ãšã¯æŒ™å‹•ã‹ã‚‰ã€‚

é©å½“ãªclassã‚’setã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚
```ts
const cls = new (class {})(); // ç©ºã®class
await DB.doc("a/b").set({cls}); //FirebaseError: Function DocumentReference.set() called with invalid data. Data must be an object, but it was: a custom object (found in document a/b)
```

ã˜ã‚ƒã‚classå…¨èˆ¬ãƒ€ãƒ¡ãªã®ã‹ã¨ã„ã†ã¨ãã†ã§ã‚‚ãªãã¦ã€Dateã¯è¨±ã•ã‚Œã¦ã‚‹ã‚‰ã—ã„ã€‚

```ts
const doc = DB.doc(`a/b`);
await doc.set({ date: new Date() });
const date = (await doc.get()).data()?.date;
console.log(date instanceof firebase.firestore.Timestamp); // true
```

æ³¨æ„ç‚¹ã¨ã—ã¦ã€Dateã‚’setã™ã‚‹ã¨ã€DateãŒ`firebase.firestore.Timestamp`ã«å‹æ‰‹ã«å¤‰æ›ã•ã‚Œã‚‹ï¼ˆä¸Šã®ã‚³ãƒ¼ãƒ‰å‚ç…§ï¼‰ã€‚

ä¿å­˜ã™ã‚‹ã¨ãã«Date->Timestampã¨å‹æ‰‹ã«å¤‰æ›ã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯ã€getã™ã‚‹ã¨ãã«ã¯é€†ã®å¤‰æ›å‡¦ç†ãŒå¿…è¦ã«ãªã‚‹ã€‚ã“ã‚Œã®å¯¾å¿œæ¡ˆã€‚

ã¡ãªã¿ã«ãªãœTimestampã§ä¿å­˜ã•ã‚Œã‚‹ã®ã‹ã¨ã„ã†ã¨ã€JSã®Dateã¯ãƒŸãƒªç§’ã¾ã§ã—ã‹æ‰±ãˆãªã„ãŒã€firestoreã¯ãƒŠãƒç§’ã¾ã§è¨˜éŒ²ã™ã‚‹ã‹ã‚‰ã€‚

##  Dateã˜ã‚ƒãªãã¦Numberã§ä¿å­˜ã™ã‚‹
firestoreã‚’JSã‹ã‚‰ã—ã‹åˆ©ç”¨ã—ãªã„ãªã‚‰ã“ã‚ŒãŒæ¥½ã€‚
```ts
const doc = DB.doc("b/c");
const date: number = Date.now();
await doc.set({ date });
const givenDate: number = (await doc.get()).data()?.date;
const date2: Date = new Date(givenDate);
```

## withConverterã‚’ä½¿ã£ã¦ã€Date<->Timestampã‚’å¤‰æ›ã™ã‚‹
ã“ã®æ–¹æ³•ã¯ã‹ãªã‚Šãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆãŒé«˜ã„ã®ã§ã€ã§ãã‚Œã°ã‚„ã‚ŠãŸããªã„ã€‚
ä»¥ä¸‹ã®`fromFirestore`ã§ã‚„ã£ã¦ã‚‹ã®ã¯
1. Timestamp->Dateã¸å†å¸°çš„ã«å¤‰æ›
2. assertionFunctionã§å‹ä»˜ã‘

ã ã‘ãªã‚“ã ã‘ã©ã€å®Ÿéš›ã«ä½¿ã£ã¦ã‚‹ã¨ã€assertionFuinctionã®ãƒ†ã‚¹ãƒˆã¨ã€timestampToDateã®ãƒ†ã‚¹ãƒˆã‚’ä¸¡æ–¹æ›¸ãã“ã¨ã«ãªã‚‹ã®ã§ã‹ãªã‚Šã‚ã‚“ã©ãã•ã„ã€‚ã—ã‹ã‚‚ã€interfaceã‚’å¤‰ãˆã‚‹ã¨assertionFuinctionã‚‚è¿½å¾“ã•ã›ãªãã‚ƒã„ã‘ãªã„ã€‚ã ã‚‹ã„ã€‚èª­ã‚€ã®ã‚‚ã ã‚‹ã„ã€‚ã»ã‚“ã¨ã«ã ã‚‹ã„ã€‚

```ts
import firebase from "firebase";
interface MyDocumentData {
  date: Date;
  events: Date[];
}
const DB = firebase.firestore();

const converter: firebase.firestore.FirestoreDataConverter<MyDocumentData> = {
  fromFirestore(ss, op) {
    const data = ss.data(op);
    const t2d = timestampToDate(data);
    assertsMyDocData(t2d);
    return t2d;
  },
  toFirestore(model: MyDocumentData) {
    return model;
  },
};
function assertsMyDocData(data: any): asserts data is MyDocumentData {
  const d = data as MyDocumentData;
  if (!(d.date instanceof Date && d.events.every((v) => v instanceof Date))) {
    throw new Error("");
  }
}
function timestampToDate(data: firebase.firestore.DocumentData) {
  const t2dEntries: [string, any][] = Object.entries(data).map(([key, val]) => {
    if (val instanceof firebase.firestore.Timestamp) {
      return [key, val.toDate()];
    } else if (val instanceof Array) {
      const newVal = val.map((v) =>
        v instanceof firebase.firestore.Timestamp
          ? v.toDate()
          : v instanceof Object
          ? timestampToDate(v)
          : v
      );
      return [key, newVal];
    } else if (val instanceof Object) {
      return [key, timestampToDate(val)];
    } else {
      return [key, val];
    }
  });
  return Object.fromEntries(t2dEntries);
}

const doc = DB.doc("f/g").withConverter(converter);
await doc.set({ date: new Date(), events: [new Date()] });
const dataRecieved = (await doc.get()).data();
console.log(dataRecieved?.date instanceof Date); //ture
console.log(dataRecieved?.events[0] instanceof Date); //true
```

## ã¾ã¨ã‚
ã ã‚‹ã„ã®ã§å‡ºæ¥ã‚‹ã ã‘Numberã§ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

# 3: firebaseã¨firebase-adminã§å¾®å¦™ã«å‹ãŒé•ã†
ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼ã§ã¾ã™ã€‚æ¢ã—ã¦ã¿ã¦ãã ã•ã„(åˆæœŸåŒ–å¿˜ã‚Œã‚’é™¤ã„ã¦)ã€‚
```ts
import firebase from "firebase";
import * as admin from "firebase-admin";

interface User {
  uid: string;
}
let adminCVT: admin.firestore.FirestoreDataConverter<User>;

const converter: firebase.firestore.FirestoreDataConverter<User> = adminCVT;
```

ç­”ãˆã¯ã“ã‚Œã§ã™ã€‚
```
adminAndClient.ts:16:7 - error TS2322: Type 'FirebaseFirestore.FirestoreDataConverter<User>' is not assignable to type 'firebase.default.firestore.FirestoreDataConverter<User>'.
  Types of property 'fromFirestore' are incompatible.
    Type '(snapshot: QueryDocumentSnapshot<DocumentData>) => User' is not assignable to type '(snapshot: QueryDocumentSnapshot<DocumentData>, options: SnapshotOptions) => User'.
      Types of parameters 'snapshot' and 'snapshot' are incompatible.
        Type 'QueryDocumentSnapshot<DocumentData>' is missing the following properties from type 'QueryDocumentSnapshot<DocumentData>': createTime, updateTime, readTime

16 const converter: firebase.firestore.FirestoreDataConverter<User> = adminCVT;
         ~~~~~~~~~


Found 1 error.
```

è¦ã™ã‚‹ã«firebaseã¨adminã§äº’æ›ãªã„ã‹ã‚‰ã‚¨ãƒ©ãƒ¼å‡ºã¦ã‚‹ã€‚ã ã‹ã‚‰`firebase-admin`ã§ä½œã£ãŸconverterã¨`firebase`ã§ä½œã£ãŸconverterã‚’ä½¿ã„ã¾ã‚ã™ã“ã¨ãŒã§ããªã„ã€‚ã ã‚‹ã„ã€‚

## è§£æ±ºç­–
ã©ã†ã«ã‹ã—ã¦ä½¿ã„ã¾ã‚ã—ãŸã„ã®ã§ã€è‡ªåˆ†ã§converterã®å‹å®šç¾©ã‚’ä½œã‚‹ã€‚
```ts
interface SnapshotOptions {
  readonly serverTimestamps?: "estimate" | "previous" | "none";
}
interface DocumentData {
  [key: string]: any;
}
interface QueryDocumentSnapshot {
  data(option?: SnapshotOptions): DocumentData;
}
type Converter<T> = {
  fromFirestore(
    snapshot: QueryDocumentSnapshot,
    op?: SnapshotOptions
  ): T;
  toFirestore(model: Partial<T>): DocumentData;
};
```
ã“ã®å®šç¾©ã‚’ä½¿ã†ã¨ã€
```ts
interface User {
  uid: string;
}
const converter: Converter<User> = {
  fromFirestore(ss, op) {
    return ss.data(op) as User;
  },
  toFirestore(model) {
    return model;
  },
};

const adminCVT: admin.firestore.FirestoreDataConverter<User> = converter;
const clientCVT: firebase.firestore.FirestoreDataConverter<User> = converter;
```
ã¿ãŸã„ã«ã€`firebase`ã¨`firebase-admin`ã§converterã‚’ä½¿ã„ã¾ã‚ã›ã‚‹ï¼ˆå‹•ä½œç¢ºèªã¯ã—ã¦ãªã„ã‘ã©å¤šåˆ†å‹•ãï¼‰ã€‚

# ã¾ã¨ã‚
firestoreã¯ã“ã†ã‚„ã£ã¦ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
```ts
import firebase from "firebase/app";
// import * as firebase from "firebase-admin"; //ã©ã¡ã‚‰ã‹
const DB = firebase.firestore()
// ä¸€ç•ªç°¡å˜ãªæ–¹æ³•
const getUserDoc = (uid: string) =>
    DB.doc(`user/${uid}`) as firebase.firestore.DocumentReference<User>

// é ‘å¼µã‚ŠãŸã„äºº
interface SnapshotOptions {
  readonly serverTimestamps?: "estimate" | "previous" | "none";
}
interface DocumentData {
  [key: string]: any;
}
interface QueryDocumentSnapshot {
  data(option?: SnapshotOptions): DocumentData;
}
type Converter<T> = {
  fromFirestore(snapshot: QueryDocumentSnapshot, op?: SnapshotOptions): T;
  toFirestore(model: Partial<T>): DocumentData;
};

interface User {
  uid: string;
}
const userConverter: Converter<User> = {
  fromFirestore(ss, op) {
    // ã“ã“ã§assertionã—ãŸã‚Šã€Timestamp->Dateã‚’æŒŸã‚“ã ã‚Šã™ã‚‹
    return ss.data(op) as User;
  },
  toFirestore(model) {
    return model;
  },
};

export const getUserDoc = (uid: string) =>
    DB.doc(`uid/${uid}`).withConverter(userConverter);
;
```

è¦‹ã¦ã®ã¨ãŠã‚Šfirestoreã¯å‹ä»˜ã‘ã‚‹ã®ï¼ˆçœŸé¢ç›®ã«ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ï¼‰å¤§å¤‰ã ã—ã€æ›¸ãè¾¼ã¿é€Ÿåº¦ãŒæ¯ç§’1å›ãã‚‰ã„ã«åˆ¶é™ã•ã‚Œã‚‹ã—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ãƒã‚«é‡ã„(ç›®ä¸‹æ”¹å–„ä¸­ã‚‰ã—ã„)ã®ã§çµæ§‹ä½¿ã„ã«ãã„ã€‚ä½¿ã„æ–¹ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚
