---
title: "JavaScriptで巨大な静的配列を実装するときはswitchよりもarrayを使ったほうが普通にはやい"
emoji: "🐥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["javascript", "typescript"]
published: true
---

# 動機
JSで巨大な事前に値が決まっている静的配列を実装するときに、Arrayじゃなくてswitchの方が早いと思ったのでベンチをとった。Denoでやったのでv8のベンチになる。

# 実験
ベンチマークを作るスクリプト。
```ts
await Deno.remove("array_switch.ts");
const Ns = [100, 1000, 10000];
for (const N of Ns) {
  const array_banch: string = `const arr${N} = [${Array.from(
    { length: N },
    (_, i) => i
  ).join(",")}];
const get_val_array${N} = (i: number) => {
    return arr${N}[i];
};
Deno.bench(
    "array_${N}",
    () => {
      for (let i = 0; i < ${N}; i++) {
        get_val_array${N}(i);
      }
}
   )`;
  const switch_bench: string = `
const get_val_switch${N} = (i: number) => {
    switch (i) {
      ${Array.from({ length: N }, (_, i) => `case ${i}: return ${i};`).join(
        "\n"
      )}
    }}
Deno.bench(
      "switch_${N}",
      () => {
        for (let i = 0; i < ${N}; i++) {
          get_val_switch${N}(i);
        }
    })
`;
  Deno.writeTextFile(`array_switch.ts`, array_banch, {
    append: true,
  });
  Deno.writeTextFile(`array_switch.ts`, switch_bench, {
    append: true,
  });
}
```

# ベンチの実行結果

```
benchmark      time/iter (avg)        iter/s      (min … max)           p75      p99     p995
-------------- ----------------------------- --------------------- --------------------------
array_100              51.9 ns    19,280,000 ( 49.1 ns … 152.8 ns)  51.0 ns  89.2 ns  98.1 ns
switch_100            101.9 ns     9,810,000 ( 85.9 ns … 247.6 ns)  96.0 ns 200.3 ns 218.8 ns
array_1000            490.3 ns     2,040,000 (456.7 ns … 760.9 ns) 495.3 ns 644.7 ns 760.9 ns
switch_1000            17.7 µs        56,620 ( 15.1 µs … 506.1 µs)  17.3 µs  46.0 µs  67.9 µs
array_10000             4.9 µs       202,300 (  4.6 µs …   5.7 µs)   5.0 µs   5.7 µs   5.7 µs
switch_10000          274.4 µs         3,644 (213.4 µs …   3.1 ms) 268.8 µs 582.3 µs 617.0 µs
```

# 感想
動的なarrayよりも、静的なswitchの方が早いと思ったが結果は逆だった。