---
title: "Next.jsã§Firebase Cloud Messaging"
emoji: "ğŸ“¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firebase", "nextjs"]
published: false
---

3-shakeã§ã‚¢ãƒ«ãƒã‚¤ãƒˆã‚’ã—ã¦ã„ã‚‹arakã§ã™ã€‚ä»Šå›ã¯Next.jsã§Firebase Cloud Messaging(FCM)ã‚’ç”¨ã„ãŸãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã®è¨˜äº‹ã¯æ¥­å‹™ã¨ã—ã¦æ›¸ã‹ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

ä»Šå›å®Ÿè£…ã™ã‚‹ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§FCMã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
1. FCMã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜
1. FCMã§é€šçŸ¥ã‚’é…ä¿¡
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§é€šçŸ¥å—ä¿¡ï¼†è¡¨ç¤º

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ“ä½œã—ã¦ã„ã‚‹webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚

ãªãŠã€ã“ã®è¨˜äº‹ã§ã¯ãƒˆãƒ”ãƒƒã‚¯ã‚„ãƒ‡ãƒã‚¤ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãªã©ã¯æ‰±ã„ã¾ã›ã‚“ã€‚




# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§FCMã®ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
ã¾ãšã¯FCMã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã¯[ã“ã‚Œ](https://firebase.google.com/docs/cloud-messaging/js/client?hl=ja#access_the_registration_token) ã§ã™ã€‚ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ServiceWorkerãŒäº‘ã€…ã¨è¨€ã£ã¦ã‚‹ã‚“ã§ã™ãŒã“ã“ã§ã¯å¿…è¦ãªã„ã§ã™ã€‚ã¾ãŸã€VAPIDéµã®ç™ºè¡Œã‚‚å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚

```ts
const FCM = () => firebase.messaging();
FCM().getToken({ vapidKey: '<YOUR_PUBLIC_VAPID_KEY_HERE>' }).then((currentToken) => {
  if (currentToken) {
  } else {
    console.log('No registration token available. Request permission to generate one.');
  }
}).catch((err) => {
  console.log('An error occurred while retrieving token. ', err);
});
```

æ³¨æ„ã¨ã—ã¦ã€`firebase.messaging()`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã‚’è¡Œã†éš›ã«å†…éƒ¨ã§`self(==window)`ã¨ã„ã†DOMå›ºæœ‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€nodeã§ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã§ããšNext.jsã®ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã™ã€‚ã‚ˆã£ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«é–¢æ•°åŒ–ã™ã‚‹ãªã©ã—ã¦è©•ä¾¡ã‚’é…å»¶ã•ã›ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ã¾ãŸã€`getToken()`ã‚’å®Ÿè¡Œã™ã‚‹ã¨é€šçŸ¥æ¨©é™ã®è¦æ±‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®è¦æ±‚ã¯[Notification](https://developer.mozilla.org/ja/docs/Web/API/Notification)ã¨ã„ã†WebAPIã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚ã‚‚ã—`getToken()`ã¨ã¯åˆ¥ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ¨©é™ã‚’è¦æ±‚ã—ãŸã„å ´åˆã€ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§è¦æ±‚ã§ãã¾ã™ã€‚

```ts
if (Notification.permission === 'granted') {
  getToken()
} else if (Notification.permission === 'default') {
  const permission = await Notification.requestPermission()
} else if (Notification.permission === 'denied') {
  console.log('permission denied')
}
```

`Notification.permission`ã§ç¾åœ¨ã®é€šçŸ¥ã®è¨±å¯ãƒ»ä¸è¨±å¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ã¾ã è¨±å¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯`Notification.requestPermission()`ã§è¨±å¯ã‚’è¦æ±‚ã§ãã¾ã™ã€‚

# FCMã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§`getToken()`ã‚’ã—ã¦å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ™®é€šã«firestoreã«ä¿å­˜ã—ã¾ã™ã€‚

[ã“ã®ãƒšãƒ¼ã‚¸](https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ja)ã«ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚å®šæœŸçš„ã«ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°ã—ã¦ã€å¤ããªã£ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

# FCMã§é€šçŸ¥ã‚’é…ä¿¡
æ¬¡ã«FCMã§é€šçŸ¥ã‚’é…ä¿¡ã—ã¾ã™ã€‚ã“ã“ã§ã¯Cloud Functionsã‚’ä½¿ã„ã¾ã™ã€‚

FCMãƒˆãƒ¼ã‚¯ãƒ³ã«å®›ã¦ã¦é€šçŸ¥ã‚’é…ä¿¡ã™ã‚‹ã«ã¯`sendMulticast()`ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```ts
import * as admin from 'firebase-admin'

const tokens = ['token1', 'token2']
const res = await admin.messaging().sendMulticast({
  tokens,
  notification: {
    title: 'ãƒ†ã‚¹ãƒˆé€šçŸ¥',
  },
})

res.responses.map((r, idx) => {
  const token = tokens[idx] // responsesã¯å„tokensã«å¯¾å¿œã—ã¦ã„ã‚‹
  if (
    r.error?.code === 'UNREGISTERED' ||
    r.error?.code === 'INVALID_ARGUMENT'
  ) {
    // tokenãŒç„¡åŠ¹ãªãŸã‚å‰Šé™¤ã™ã‚‹ã¨ã‚ˆã„
    deleteToken(token)
  }
})
```

`sendMulticast()`ã®è¿”ã‚Šå€¤`res.responses`ã¯`tokens`ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Š`res.responses[idx]`ã¯`tokens[idx]`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ã™ã€‚ã¾ãŸã€`sendMulticast()`ã¯ï¼‘åº¦ã«500ãƒˆãƒ¼ã‚¯ãƒ³ã¾ã§ã—ã‹é€šçŸ¥ã‚’é…ä¿¡ã§ãã¾ã›ã‚“ã€‚501ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆã¯è¤‡æ•°å›é€ä¿¡ã—ã¦ãã ã•ã„ã€‚

ã‚³ãƒ¼ãƒ‰ä¸­ã®ï¼’ã¤ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®æ™‚ã¯ï¼’åº¦ã¨ãã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚‰ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å‰Šé™¤ã—ã¦ãŠãã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚[å‚è€ƒ](https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ja#detect-invalid-token-responses-from-the-fcm-backend)

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§é€šçŸ¥å—ä¿¡ï¼†è¡¨ç¤º

ä»¥ä¸Šã®æ–¹æ³•ã§é…ä¿¡ã—ãŸé€šçŸ¥ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚é€ã‚Œã°å‹æ‰‹ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚è¡¨ç¤ºå‡¦ç†ãŒå¿…è¦ã§ã™ã€‚ã“ã®å‡¦ç†ã¯ã€Webã‚¢ãƒ—ãƒªãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹ã¨ãã¯ã‚¢ãƒ—ãƒªè‡ªèº«ãŒã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹ã¨ãã¯ServiceWorkerãŒè¡Œã„ã¾ã™ã€‚

## ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹å ´åˆ

ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹å ´åˆã¯ç°¡å˜ã§ã™ã€‚
```ts
import firebase from 'firebase/app'

const unsubscribe = firebase.messaging().onMessage((payload) => {
  // ...
})

unsubscribe() // è³¼èª­è§£é™¤
```

ã“ã†ã—ã¦å—ã‘å–ã£ãŸé€šçŸ¥ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚‚`Notification`APIã‚’ä½¿ã„ã¾ã™ã€‚è©¦ã—ã«localhostãªã©ã§ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```ts
Notification.requestPermission().then(()=>new Notification("test"))
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æ¨©é™ã®è¦æ±‚ã¨é€šçŸ¥ã®è¡¨ç¤ºãŒã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/fd6a687a0c29-20220413.png)
![](https://storage.googleapis.com/zenn-user-upload/82860a238f6e-20220413.png)

ã“ã®ã‚ˆã†ã«ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’è¡¨ç¤ºã§ãã¾ã™ã—ã€ä»£ã‚ã‚Šã«Webã‚¢ãƒ—ãƒªã®UIä¸Šã§é€šçŸ¥ã™ã‚‹ã“ã¨ã‚‚ã€ç„¡è¦–ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

## ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹å ´åˆ
ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹å ´åˆã¯ServiceWorker(SW)ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ã®ã§ã‚ã‚“ã©ãã•ã„ã§ã™ã€‚

SWã®è¨­å®šã‚’ã—ã¾ã™ãŒã€ãã®å‰ã«Typescriptã‚’ä½¿ã£ã¦ã„ã‚‹äººã¯`tsconfig.json`ã®`lib`ã«`"WebWorker"`ã‚’è¿½åŠ ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ãã‚Œã§ã¯æœ€åˆã«`next-pwa`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨SWã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã¯åˆ¥ã§ã™ã€‚ãã®ãŸã‚æ™®é€šã«Next.jsã‚’ä½¿ã†å ´åˆã€SWã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ã‚„ãƒãƒªãƒ•ã‚£ãƒ«ã‚’ä½¿ã£ã¦è‡ªåŠ›ã§ãƒ“ãƒ«ãƒ‰ã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ãŒã€next-pwaãŒã‚ã‚Œã°ã„ã„æ„Ÿã˜ã«ã—ã¦ãã‚Œã¾ã™ã€‚
```sh
yarn add next-pwa
```

æ¬¡ã«next-pwaã‚’è¨­å®šã—ã¾ã™ã€‚
```js:next.config.js
const withPWA = require('next-pwa')

module.exports = withPWA({
  pwa: {
    dest: 'public', // publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«SWã‚’å‡ºåŠ›ã™ã‚‹
    register: false // next-pwaãŒè‡ªå‹•ã§SWã‚’ç™»éŒ²ã™ã‚‹ã®ã‚’ç„¡åŠ¹ã«ã™ã‚‹
  }
})
```

next-pwaã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`worker`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’SWã¨ã—ã¦æ‰±ã„ã€`public/sw.js`ã«ãƒ“ãƒ«ãƒ‰å¾Œã®SWã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

ãã‚Œã§ã¯SWã‚’æ›¸ãã¾ã™ã€‚

```ts:worker/index.ts
declare let self: ServiceWorkerGlobalScope

import firebase from 'firebase/app'
import 'firebase/messaging'

firebase.initializeApp({...config})
const messaging = firebase.messaging()

messaging.onBackgroundMessage((payload) => {
  const title = payload.notification?.title
  const body = payload.notification?.body
  self.registration.showNotification(title, {
    body,
  })
})
```

declareå®£è¨€ã§SWã®ãŠã¾ã˜ãªã„ã‚’ã—ã¾ã™ã€‚

ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã‚ã‚‹å ´åˆã¨é•ã„ã€SWã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’è¡¨ç¤ºã«ã™ã‚‹ã«ã¯`self.registration.showNotification()`ã‚’ä½¿ã„ã¾ã™ã€‚

ã“ã®SWã‚’ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ç™»éŒ²ã—ã¾ã™ã€‚`getToken()`ã®`serviceWorkerRegistration`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã—ãŸSWã‚’æ¸¡ã—ã¾ã™ã€‚

```ts
const serviceWorkerRegistration = await navigator.serviceWorker.register(
  '/sw.js',
  {
    scope: 'firebase-cloud-messaging-push-scope', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æŒ‡å®šã•ã‚Œã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒæƒãˆã¦ãŠãã€‚
  }
)
firebase.messaging().getToken({
  vapidKey: '<YOUR_PUBLIC_VAPID_KEY_HERE>',
  serviceWorkerRegistration,
})
```

### (ç•ªå¤–ç·¨)ESMã§SWã‚’æ›¸ã
ã›ã£ã‹ãfirebase-js-sdk v9ã§ESMå¯¾å¿œã—ãŸã®ã§ESMã§SWã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```js:public/sw.js
import { initializeApp } from "https://esm.sh/firebase/app";
import {
  getMessaging,
  onBackgroundMessage,
} from "https://esm.sh/firebase/messaging/sw";

const firebaseApp = initializeApp({});
const messaging = getMessaging(firebaseApp);

console.log("hello serviceWorker!");

onBackgroundMessage(messaging, (payload) => {
  self.registration.showNotification("hello firebase");
});
```

å€‹äººçš„ã«ã¯ã“ã£ã¡ã‚’ã¨ã¦ã‚‚ä½¿ã„ãŸã„ã§ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚Typescriptã‚‚ã¾ã ã‚µãƒãƒ¼ãƒˆãŒè¿½ã„ã¤ã„ã¦ãªã„ã®ã§è«¦ã‚ã¾ã—ãŸã€‚ã€‚ã€‚