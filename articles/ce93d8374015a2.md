---
title: "Parsecで再帰下降パーサーを書くテクニック"
emoji: "👌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Haskell", "Parsec"]
published: false
---

Haskellという言語にはParsecというライブラリがあります。Parsecはモナディックな再帰下降パーサーとして有名で、小さなパーサーを組み合わせて大きなパーサーを作ることができます。Parsecは非常に洗練されている一方で、慣れるまではクセがあって使いにくく感じることがあります。この記事では備忘録を兼ねて、自分がParsecを書くときに使うテクニックを紹介します。

# 基本の型
[ParsecT](https://hackage.haskell.org/package/parsec-3.1.16.1/docs/Text-Parsec.html#t:ParsecT)は最も基本的な型です。

```hs
data ParsecT s u m a
```
について、sは入力列（文字列やトークン列）、uはパーサーの状態、mはモナド、aはパーサーの帰り値です。

特徴的な引数について説明します。

`ParsecT`はモナド変換子なので`m`を引数に取ります。しかしモナド変換を行わない場合も多いため、`m`にIdentityモナドを適用した`Parsec`型も定義されています。

`u`はパーサーの状態です。状態つきのパーサーが必要なときに使います。PythonやHaskellはインデントが意味を持つので、現在のインデントの深さを保持しつつパースするときなどに使います（多分）。一般的な文法だと状態つきパーサーを必要としないことも多いので、そういった場合は`()`を適用しておけば大丈夫です。

`s`, `a`はそれぞれ入力と出力の型に対応します。
# パーサーの動かし方

まずは基本中の基本、パーサーの動かし方です。
パーサーを実行する関数としては

| 関数                                                                                                            |                実行するパーサーの型                |
| :-------------------------------------------------------------------------------------------------------------- | :------------------------------------------------: |
| [runParserT](https://hackage.haskell.org/package/parsec-3.1.16.1/docs/Text-Parsec.html#v:runParserT)            |                 `ParsecT s u m a`                  |
| [runParser](https://hackage.haskell.org/package/parsec-3.1.16.1/docs/Text-Parsec.html#v:runParser)              | `ParsecT s u Identity a` <br> =     `Parsec s u a` |
| [parse](https://hackage.haskell.org/package/parsec-3.1.16.1/docs/Text-Parsec.html#v:parse)                      |  `ParsecT s () Identity a` <br>= `Parsec s () a`   |
| [parseTest](https://hackage.haskell.org/package/parsec-3.1.16.1/docs/Text-Parsec.html#v:parseTest) (デバッグ用) |                    parseと同じ                     |

があります。一番上が最もプリミティブなもので、下に行くにつれてより特殊化された実装になっています。

実際に使用する場合は、

```hs
data Token = ExampleToken deriving (Show)

parser :: ParsecT String () Identity Token
parser = pure ExampleToken

main :: IO ()
main = do
    let fileName = "/Users/user/nand2tetris/asm-hs/asm-hs.prof"
    fileText <- readFile fileName
    let state = ()
    let result = runParserT parser state fileName fileText
    print result -- Identity (Right ExampleToken)
```

のように動かします。

# 文字列のパースの仕方



# Tokenizer編
Tokenizerは文字列をトークン列(終端記号列)に変換します。

