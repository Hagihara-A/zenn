---
title: "超型安全firestoreができた"
emoji: "🎆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["firestore", "firebase", "typescript"]
published: true
---

firebaseってtypescriptと相性わるいな～～～～～～～～～とまじで思ってたので超型安全firestore作ってみたらできました。パスまで型安全でやってくれます。これです。
https://github.com/Hagihara-A/fire-fuse

npmにまだあげてないので試したいならcloneしてください。

# 特徴/出来ること
- オリジナルfirestore v9と全く同じインターフェイス。ただし型安全
- ドキュメント/コレクションパスの型付け
- パスを解析して型付けした`Document/CollectionReference`を返せる
- `updateDoc(ref, {"p1.p2.p3": "hogehoge"})`のようなドットつなぎ指定をサポート

# 使い方

まずはコレクションの階層関係を表したスキーマを定義します。

```ts
import { Collection } from "firefuse";

type User = {
  name: string;
  age: number;
};
type Payment = {
  cardNumber: number;
};
type Room = {
  size: number;
  rooms: {
    living: number;
    dining: number;
    kitchen: number;
  };
};
type MySchema = {
  user: Collection<User, { payment: Collection<Payment> }>;
  room: Collection<Room>;
};
```

このスキーマがどういう仕組みになっているかというと

- `user/{userId}` -> `User`
- `user/{userId}/payment/{paymentId}` -> `Payment`
- `room/{roomId}` -> `Room`

という、コレクションの関係を表します。このスキーマを作ることで、パスの型付けが可能になります。このスキーマを与えて、firestoreを操作する関数を得ます。

```ts
import * as fuse from "firefuse";
const collection = fuse.collection<MySchema>();
const doc = fuse.doc<MySchema>();
```

ここで生成した`collection` `doc`はオリジナルfirestore v9と同じインターフェイスをもちます。セットアップはこれだけです。

実際に使ってみます

```ts
// const DB = getFirestore();
const paymentColRef = collection(DB, "user", "a", "payment"); // ✅
const paymentColRef = collection(DB, "not", "exists", "path"); // ❌:     型 '["not", "exists", "path"]' を型 '["user", string, "payment"]' に割り当てることはできません。
const paymentDocRef = doc(DB, "user", "a", "payment", "b"); // ✅
const paymentDocRef = doc(DB, "user", "a", "not", "exists"); // ❌:   型 '["user", "a", "not", "exists"]' を型 '["user", string, "payment", string]' に割り当てることはできません。
```

コレクション/ドキュメントの参照を型安全にできました。これが一番の目玉です。例えば`user`を`users`のようにtypoしてもエラーを出してくれます。

ちなみに、この`doc`, `collection`の返り値は独自実装ではなく、firestoreの`CollectionReference`や`DocumentReference`を返します。繰り返すようですが、このパッケージは型付けのみ行います。

次にupdateです

```ts
const roomDocRef = doc(DB, "room", "roomId"); // ("rooms", "roomId")のようなtypoもエラーを出します
fuse.updateDoc(roomDocRef, { "rooms.dining": 123 }); // ✅
fuse.updateDoc(roomDocRef, { "rooms.dining": "abc" }); // ❌: 型 'string' を型 'number' に割り当てることはできません。
fuse.updateDoc(roomDocRef, { rooms: { dining: 1, kitchen: 2, living: 3 } }); // ✅
fuse.updateDoc(roomDocRef, { rooms: { dining: "a", kitchen: "b", living: "c" } }); // ❌: 型 'string' を型 'number' に割り当てることはできません。 
```

updateも型安全です。

というかんじで結構良い感じのパッケージができたので紹介しました。queryやarrayUnionなどのFieldValue系などまだ対応してない機能は多くあるんですが、もし機能が足りなくてもいつでもオリジナルfirestoreと混ぜて使うことができるというのは強みだと思っています。
