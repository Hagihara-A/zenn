---
title: "è¶…å‹å®‰å…¨firestoreãŒã§ããŸ(æ›´æ–°)"
emoji: "ğŸ†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firestore", "firebase", "typescript"]
published: true
---

firebase ã£ã¦ typescript ã¨ç›¸æ€§ã‚ã‚‹ã„ãªï½ï½ï½ï½ï½ï½ï½ï½ï½ã¨ã¾ã˜ã§æ€ã£ã¦ãŸã®ã§è¶…å‹å®‰å…¨ firestore ä½œã£ã¦ã¿ãŸã‚‰ã§ãã¾ã—ãŸã€‚ãƒ‘ã‚¹ã¾ã§å‹å®‰å…¨ã§ã‚„ã£ã¦ãã‚Œã¾ã™ã€‚ã“ã‚Œã§ã™ã€‚
https://github.com/Hagihara-A/fire-fuse

`npm i firefuse`
ã§ä½¿ãˆã¾ã™

firestore-v9 ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

# ç‰¹å¾´/å‡ºæ¥ã‚‹ã“ã¨

- ãŸã ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã®ã§ã€ä¸€åˆ‡ã®ç‹¬è‡ªå®Ÿè£…ãŒãªã„ã€‚ãŸã ã—å‹å®‰å…¨ã€‚
- ãƒ‘ã‚¹ã®å‹ä»˜ã‘
- ãƒ‘ã‚¹ã‚’è§£æã—ã¦`Reference`ã‚’å‹ä»˜ã‘ã§ãã‚‹

# ãªã«ãŒã§ãã‚‹ã‹

```ts
// /user/{uid}/payment/{payId}/paymentLog/{logId}ã¨ã„ã†é–¢ä¿‚ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©æ¸ˆã¨ã™ã‚‹
const DB = firestore.getFirestore();

collection(DB, "user"); // âœ…
collection(DB, "users"); // âŒ: Type '"users"' is not assignable to type '"user"'
collection(DB, "user", "uid", "payment", "pid", "paymentLog"); // âœ…
collection(DB, "user", "uid", "payment", "pid", "paymentsLog"); // âŒ: Type '"paymentsLog"' is not assignable to type '"paymentLog"'

doc(DB, "user", "uid"); // âœ…
doc(DB, "users", "uid"); // âŒ: Type '"users"' is not assignable to type '"user"'
doc(DB, "user", "uid", "payment", "pid", "paymentsLog", "logid"); // âŒ: Type '"paymentsLog"' is not assignable to type '"paymentLog"'
```

`user`ã‚’`users` ã¨ã™ã‚‹ã‚ˆã†ãª typo ã‚’é˜²ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã¾ãŸã€æŒ‡å®šã—ãŸãƒ‘ã‚¹ã‚’è§£æã—ã¦ã€ã©ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã®ã‹å‹ä»˜ã‘ã—ã¦è¿”ã—ã¦ãã‚Œã¾ã™ã€‚ã¤ã¾ã‚Š`collection(DB, "user")`ã¯`DocumentReference<User>`ã®è¿”ã‚Šå€¤ã«ãªã‚Šã¾ã™ã€‚

# ä½¿ã„æ–¹

ã¾ãšã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®éšå±¤é–¢ä¿‚ã‚’è¡¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

```ts
type Schema = {
  user: {
    doc: User;
    subcollection: {
      payment: {
        doc: Payment;
        subcollection: {
          paymentLog: {
            doc: PaymentLog;
          };
        };
      };
    };
  };
};
type User = {
  name: { first: string; last: number; middle?: string };
  age: number;
  sex: "male" | "female" | "other";
  birthDay: firestore.Timestamp;
  skills: string[];
  isStudent: boolean;
};

type Payment = {
  company: string;
  cardNumber: number;
  expire: firestore.Timestamp;
};

type PaymentLog = {
  settledAt: firestore.Timestamp;
  amount: number;
};
```

é•·ã„ã§ã™ãŒè¤‡é›‘ã§ã¯ãªã„ã§ã™ã€‚
ã“ã®ã‚¹ã‚­ãƒ¼ãƒãŒã©ã†ã„ã†ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨

- `user/{userId}` -> `User`
- `user/{userId}/payment/{paymentId}` -> `Payment`
- `user/{userId}/payment/{paymentId}/paymentLog/{logId}` -> `PaymentLog`

ã¨ã„ã†ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã®é–¢ä¿‚ã‚’è¡¨ã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¹ã®å‹ä»˜ã‘ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä¸ãˆã¦ã€firestore ã‚’æ“ä½œã™ã‚‹é–¢æ•°ã‚’å¾—ã¾ã™ã€‚

```ts
import * as fuse from "firefuse";
const collection = fuse.collection<Schema>();
const doc = fuse.doc<Schema>();
const where = fuse.where<User>();
const orderBy = fuse.orderBy<User>();
```

ã“ã‚Œã ã‘ã§ã™ã€‚ä»–ã®è¨­å®šã¯ä¸€åˆ‡è¦ã‚Šã¾ã›ã‚“ã€‚

ã¾ãŸã€ã“ã“ã§ç”Ÿæˆã—ãŸ`collection` `doc`ã¯ã‚ªãƒªã‚¸ãƒŠãƒ« firestore v9 ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã‚‚ã¡ã¾ã™ã€‚

å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã™

```ts
// const DB = getFirestore();
const paymentColRef = collection(DB, "user", "a", "payment"); // âœ…
const paymentColRef = collection(DB, "not", "exists", "path"); // âŒ:     å‹ '["not", "exists", "path"]' ã‚’å‹ '["user", string, "payment"]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
const paymentDocRef = doc(DB, "user", "a", "payment", "b"); // âœ…
const paymentDocRef = doc(DB, "user", "a", "not", "exists"); // âŒ:   å‹ '["user", "a", "not", "exists"]' ã‚’å‹ '["user", string, "payment", string]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å‹å®‰å…¨ã«ã§ãã¾ã—ãŸã€‚ã“ã‚ŒãŒä¸€ç•ªæ°—ã«å…¥ã£ã¦ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

# ã‚¯ã‚¨ãƒª

ã‚¯ã‚¨ãƒªã‚‚å‹å®‰å…¨ã§ã™ã€‚

```ts
const userCol = collection(DB, "user");
const { query } = fuse;
const where = fuse.where<User>();
const orderBy = fuse.orderBy<User>();
```

ã‚¯ã‚¨ãƒªã¯è‰²ã€…ã§ãã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

## å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã¨ã€å‹ãŒé•ã†å€¤ã‚’ã‚¯ã‚¨ãƒªã«ã§ããªã„

```ts
where("age", "==", 22); // âœ…
where("age", "==", "22"); // âŒ: Argument of type 'string' is not assignable to parameter of type 'number'.
```

ã‚ˆãã‚ã‚‹ã‚„ã¤ã§ã™

## ã‚¯ã‚¨ãƒªã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…ãšå­˜åœ¨ã™ã‚‹

firestore ã®ä»•æ§˜ã¨ã—ã¦ã€ã‚¯ã‚¨ãƒªã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãƒãƒƒãƒã—ãªã„ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ãƒ’ãƒƒãƒˆã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å¿…ãšãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã¾ã™ã€‚ã“ã‚Œã‚‚å‹ä»˜ã‘ã§ãã¾ã™ã€‚

```ts
const q1 = query(userCol, where("age", ">", 22)); // âœ…: queried docs are typed to have `.age` property
firestore.getDocs(q1).then((qs) => qs.docs.map((doc) => doc.data().age));
```

ã“ã® age ãŒ optional ã ã£ãŸã¨ã—ã¦ã‚‚ã€required ã§ã‹ãˆã£ã¦ãã¾ã™ã€‚

## ä¸æ­£ãªã‚¯ã‚¨ãƒªã‚’æ¤œçŸ¥ã™ã‚‹

firestore ã«ã¯`!=`ã¨`not-in`ã‚’çµ„ã¿åˆã‚ã›ã‚‰ã‚Œãªã„ã¨ã‹ã€`array-contains`ã¨`array-contains-any`ã‚’çµ„ã¿åˆã‚ã›ã‚‰ã‚Œãªã„ã¨ã‹ã€ã•ã‚‰ã«`in` `not-in` `array-contains-any`ã®ã†ã¡ã²ã¨ã¤ã¾ã§ã—ã‹ä½¿ãˆãªã„ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒå±±ã»ã©ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«å½“ã¦ã¯ã¾ã‚‹ã‚¯ã‚¨ãƒªã‚’ã™ã‚‹ã¨ã€`never`ã§è¿”ã—ã¾ã™ã€‚

```ts
const q2 = query(userCol, where("age", ">", 22), where("sex", "<", "male")); // âŒ: filter on multiple field (firestore's limitation).
firestore.getDocs(q2).then((qs) => qs.docs.map((doc) => doc.data())); // now, doc.data() is never

const q3 = query(
  userCol,
  where("age", ">", 22),
  where("sex", "not-in", ["male"])
); // âŒ: "<", "<=", ">=", ">", "!=" and not-in must filter the same field (firestore's limitation).
firestore.getDocs(q3).then((qs) => qs.docs.map((doc) => doc.data().age)); // doc.data() is never

query(
  userCol,
  where("sex", "in", ["female", "male"]),
  where("age", "not-in", [22, 23]),
  where("skills", "array-contains-any", ["c", "java"])
); // âŒ:  in, not-in or array-contains-any must not be used at the same time and appear only once (firestore's limitation).

query(userCol, where("age", "<", 22), orderBy("age"), orderBy("birthDay")); // âœ…
query(userCol, where("age", ">", 23), orderBy("birthDay")); //âŒ: if you include a filter with a range comparison (<, <=, >, >=), your first ordering must be on the same field: (firestore's limitation)

// use other constraints
const { limit, limitToLast, startAt, startAfter, endAt, endBefore } = fuse;
```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã­ã€‚ã¡ãªã¿ã« firestore ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã«ã¯é€šã‚‹ã‘ã©ã€æœ¬ç•ªç’°å¢ƒã ã¨é€šã‚‰ãªã„ã‚¯ã‚¨ãƒªãŒå­˜åœ¨ã™ã‚‹ã‚‰ã—ãã€ãã†ã„ã†ã®ã‚‚äº‹å‰ã«æŠŠæ¡ã§ãã¾ã™ã€‚

## `==`ã‚„`in`, `not-in`ãªã©ã§åˆ¶é™ã—ãŸå€¤ã«å‹ãŒã¤ã

ä¸Šè¿°ã®`User`ã ã¨`sex`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«`"male"` `"female"` `"other"`ã¨ã„ã†ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¦ç®¡ç†ã—ã¦ãŸã¨ã—ã¾ã™ã€‚ã“ã‚Œã«`where("sex", "!=", "male")`ã‚¯ã‚¨ãƒªã‹ã‘ã¦ã‚‚ã€ç´ ã® firestore ã¯ãã‚ŒãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€å‹ä»˜ã‘ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚`firefuse`ãªã‚‰ã“ã‚Œã‚‚ã§ãã¾ã™ã€‚

```ts
const q4 = query(userCol, where("sex", "!=", "male" as const)); // âœ…: note `as const`
firestore.getDocs(q4).then((qs) => qs.docs.map((doc) => doc.data().sex)); // now, sex is `"female" | "other"` because you removed it !!

const q5 = query(userCol, where("age", "==", 30 as const)); // âœ…: note `as const`
firestore.getDocs(q5).then((qs) => qs.docs.map((doc) => doc.data().age === 30)); // now age === 30, becase you queried!!
```

ã¿ã¦ã®ã‚ˆã†ã«ã€`where(sex, !=, male)`ã™ã‚‹ã¨ã€`sex: "female" | "other"`ã¨æ¨è«–ã—ã¾ã™ã€‚`where(age, ==, 30)`ã«ã™ã‚‹ã¨ã€`age: 30`ã«æ¨è«–ã—ã¾ã™ã€‚

# ãªã«ãŒä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨é•ã†ã®ã‹

ã“ã‚Œã¾ã§ firestore ã‚’æ“ä½œã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æ•°å¤šãå‡ºã¦ãã¾ã—ãŸã€‚ã—ã‹ã—ãã®å¤šãã¯ã€ã‹ã‚†ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šã‹ãªã„ã‚ˆã†ãªã€å¾®å¦™ãªä½¿ã„å‹æ‰‹ã®æ‚ªã•ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ãªæ™‚ã«ã„ã¡ã„ã¡å…ƒã® firestore ã‚’å¼•ã£å¼µã‚Šå‡ºã—ã¦ãã¦ã€ç„¡ç†ã‚„ã‚Šå®Ÿè£…ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ãŸäº‹ã®ã‚ã‚‹äººã¯å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä¸€æ–¹ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã¯ãã®ã‚ˆã†ãªã“ã¨ã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¿°ã¹ãŸã‚ˆã†ã«ã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã ã‹ã‚‰ã§ã™ã€‚å†…éƒ¨çš„ã«ã¯ã€`collection`ã‚„`doc`ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã ã‘ã®å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ã ã‘ã§ã™ã€‚

firebase v9 ã¸ã®ç§»è¡Œã®æ™‚ã«ä¸€ç·’ã«ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ã€‚
