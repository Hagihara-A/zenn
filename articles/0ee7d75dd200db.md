---
title: "è¶…å‹å®‰å…¨firestoreãŒã§ããŸ"
emoji: "ğŸ†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firestore", "firebase", "typescript"]
published: true
---

firebaseã£ã¦typescriptã¨ç›¸æ€§ã‚ã‚‹ã„ãªï½ï½ï½ï½ï½ï½ï½ï½ï½ã¨ã¾ã˜ã§æ€ã£ã¦ãŸã®ã§è¶…å‹å®‰å…¨firestoreä½œã£ã¦ã¿ãŸã‚‰ã§ãã¾ã—ãŸã€‚ãƒ‘ã‚¹ã¾ã§å‹å®‰å…¨ã§ã‚„ã£ã¦ãã‚Œã¾ã™ã€‚ã“ã‚Œã§ã™ã€‚
https://github.com/Hagihara-A/fire-fuse

npmã«ã¾ã ã‚ã’ã¦ãªã„ã®ã§è©¦ã—ãŸã„ãªã‚‰cloneã—ã¦ãã ã•ã„ã€‚

# ç‰¹å¾´/å‡ºæ¥ã‚‹ã“ã¨
- ã‚ªãƒªã‚¸ãƒŠãƒ«firestore v9ã¨å…¨ãåŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã€‚ãŸã ã—å‹å®‰å…¨
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ã®å‹ä»˜ã‘
- ãƒ‘ã‚¹ã‚’è§£æã—ã¦å‹ä»˜ã‘ã—ãŸ`Document/CollectionReference`ã‚’è¿”ã›ã‚‹
- `updateDoc(ref, {"p1.p2.p3": "hogehoge"})`ã®ã‚ˆã†ãªãƒ‰ãƒƒãƒˆã¤ãªãæŒ‡å®šã‚’ã‚µãƒãƒ¼ãƒˆ

# ä½¿ã„æ–¹

ã¾ãšã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®éšå±¤é–¢ä¿‚ã‚’è¡¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

```ts
import { Collection } from "firefuse";

type User = {
  name: string;
  age: number;
};
type Payment = {
  cardNumber: number;
};
type Room = {
  size: number;
  rooms: {
    living: number;
    dining: number;
    kitchen: number;
  };
};
type MySchema = {
  user: Collection<User, { payment: Collection<Payment> }>;
  room: Collection<Room>;
};
```

ã“ã®ã‚¹ã‚­ãƒ¼ãƒãŒã©ã†ã„ã†ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨

- `user/{userId}` -> `User`
- `user/{userId}/payment/{paymentId}` -> `Payment`
- `room/{roomId}` -> `Room`

ã¨ã„ã†ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®é–¢ä¿‚ã‚’è¡¨ã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¹ã®å‹ä»˜ã‘ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä¸ãˆã¦ã€firestoreã‚’æ“ä½œã™ã‚‹é–¢æ•°ã‚’å¾—ã¾ã™ã€‚

```ts
import * as fuse from "firefuse";
const collection = fuse.collection<MySchema>();
const doc = fuse.doc<MySchema>();
```

ã“ã“ã§ç”Ÿæˆã—ãŸ`collection` `doc`ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«firestore v9ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã‚‚ã¡ã¾ã™ã€‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ã“ã‚Œã ã‘ã§ã™ã€‚

å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã™

```ts
// const DB = getFirestore();
const paymentColRef = collection(DB, "user", "a", "payment"); // âœ…
const paymentColRef = collection(DB, "not", "exists", "path"); // âŒ:     å‹ '["not", "exists", "path"]' ã‚’å‹ '["user", string, "payment"]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
const paymentDocRef = doc(DB, "user", "a", "payment", "b"); // âœ…
const paymentDocRef = doc(DB, "user", "a", "not", "exists"); // âŒ:   å‹ '["user", "a", "not", "exists"]' ã‚’å‹ '["user", string, "payment", string]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å‹å®‰å…¨ã«ã§ãã¾ã—ãŸã€‚ã“ã‚ŒãŒä¸€ç•ªã®ç›®ç‰ã§ã™ã€‚ä¾‹ãˆã°`user`ã‚’`users`ã®ã‚ˆã†ã«typoã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦ãã‚Œã¾ã™ã€‚

ã¡ãªã¿ã«ã€ã“ã®`doc`, `collection`ã®è¿”ã‚Šå€¤ã¯ç‹¬è‡ªå®Ÿè£…ã§ã¯ãªãã€firestoreã®`CollectionReference`ã‚„`DocumentReference`ã‚’è¿”ã—ã¾ã™ã€‚ç¹°ã‚Šè¿”ã™ã‚ˆã†ã§ã™ãŒã€ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å‹ä»˜ã‘ã®ã¿è¡Œã„ã¾ã™ã€‚

æ¬¡ã«updateã§ã™

```ts
const roomDocRef = doc(DB, "room", "roomId"); // ("rooms", "roomId")ã®ã‚ˆã†ãªtypoã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¾ã™
fuse.updateDoc(roomDocRef, { "rooms.dining": 123 }); // âœ…
fuse.updateDoc(roomDocRef, { "rooms.dining": "abc" }); // âŒ: å‹ 'string' ã‚’å‹ 'number' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
fuse.updateDoc(roomDocRef, { rooms: { dining: 1, kitchen: 2, living: 3 } }); // âœ…
fuse.updateDoc(roomDocRef, { rooms: { dining: "a", kitchen: "b", living: "c" } }); // âŒ: å‹ 'string' ã‚’å‹ 'number' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ 
```

updateã‚‚å‹å®‰å…¨ã§ã™ã€‚

ã¨ã„ã†ã‹ã‚“ã˜ã§çµæ§‹è‰¯ã„æ„Ÿã˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã§ããŸã®ã§ç´¹ä»‹ã—ã¾ã—ãŸã€‚queryã‚„arrayUnionãªã©ã®FieldValueç³»ãªã©ã¾ã å¯¾å¿œã—ã¦ãªã„æ©Ÿèƒ½ã¯å¤šãã‚ã‚‹ã‚“ã§ã™ãŒã€ã‚‚ã—æ©Ÿèƒ½ãŒè¶³ã‚Šãªãã¦ã‚‚ã„ã¤ã§ã‚‚ã‚ªãƒªã‚¸ãƒŠãƒ«firestoreã¨æ··ãœã¦ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã®ã¯å¼·ã¿ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
