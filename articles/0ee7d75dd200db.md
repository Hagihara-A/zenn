---
title: "è¶…å‹å®‰å…¨firestoreãŒã§ããŸ(æ›´æ–°)"
emoji: "ğŸ†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firestore", "firebase", "typescript"]
published: true
---

firebaseã£ã¦typescriptã¨ç›¸æ€§ã‚ã‚‹ã„ãªï½ï½ï½ï½ï½ï½ï½ï½ï½ã¨ã¾ã˜ã§æ€ã£ã¦ãŸã®ã§è¶…å‹å®‰å…¨firestoreä½œã£ã¦ã¿ãŸã‚‰ã§ãã¾ã—ãŸã€‚ãƒ‘ã‚¹ã¾ã§å‹å®‰å…¨ã§ã‚„ã£ã¦ãã‚Œã¾ã™ã€‚ã“ã‚Œã§ã™ã€‚
https://github.com/Hagihara-A/fire-fuse

`npm i firefuse`
ã§ä½¿ãˆã¾ã™

firestore-v9ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

# ç‰¹å¾´/å‡ºæ¥ã‚‹ã“ã¨
- ãŸã ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã®ã§ã€ä¸€åˆ‡ã®ç‹¬è‡ªå®Ÿè£…ãŒãªã„ã€‚ãŸã ã—å‹å®‰å…¨ã€‚
- ãƒ‘ã‚¹ã®å‹ä»˜ã‘
- ãƒ‘ã‚¹ã‚’è§£æã—ã¦`Reference`ã‚’å‹ä»˜ã‘ã§ãã‚‹

# ãªã«ãŒã§ãã‚‹ã‹
```ts
// /user/{uid}/payment/{payId}/paymentLog/{logId}ã¨ã„ã†é–¢ä¿‚ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©æ¸ˆã¨ã™ã‚‹
const DB = firestore.getFirestore();

collection(DB, "user"); // âœ…
collection(DB, "users"); // âŒ: Type '"users"' is not assignable to type '"user"'
collection(DB, "user", "uid", "payment", "pid", "paymentLog"); // âœ…
collection(DB, "user", "uid", "payment", "pid", "paymentsLog"); // âŒ: Type '"paymentsLog"' is not assignable to type '"paymentLog"'

doc(DB, "user", "uid"); // âœ…
doc(DB, "users", "uid"); // âŒ: Type '"users"' is not assignable to type '"user"'
doc(DB, "user", "uid", "payment", "pid", "paymentsLog", "logid"); // âŒ: Type '"paymentsLog"' is not assignable to type '"paymentLog"'
```

`user`ã‚’`users`ã®ã‚ˆã†ãªtypoã‚’é˜²ãã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ã¾ãŸã€æŒ‡å®šã—ãŸãƒ‘ã‚¹ã‚’è§£æã—ã¦ã€ã©ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ/ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã®ã‹å‹ä»˜ã‘ã—ã¦è¿”ã—ã¦ãã‚Œã¾ã™ã€‚ã¤ã¾ã‚Š`collection(DB, "user")`ã¯`DocumentReference<User>`ã®è¿”ã‚Šå€¤ã«ãªã‚Šã¾ã™ã€‚

# ä½¿ã„æ–¹

ã¾ãšã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®éšå±¤é–¢ä¿‚ã‚’è¡¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

```ts
type Schema = {
  user: {
    doc: User;
    subcollection: {
      payment: {
        doc: Payment;
        subcollection: {
          paymentLog: {
            doc: PaymentLog;
          };
        };
      };
    };
  };
};
type User = {
  name: { first: string; last: number; middle?: string };
  age: number;
  sex: "male" | "female" | "other";
  birthDay: firestore.Timestamp;
  skills: string[];
  isStudent: boolean;
};

type Payment = {
  company: string;
  cardNumber: number;
  expire: firestore.Timestamp;
};

type PaymentLog = {
  settledAt: firestore.Timestamp;
  amount: number;
};
```

é•·ã„ã§ã™ãŒè¤‡é›‘ã§ã¯ãªã„ã§ã™ã€‚
ã“ã®ã‚¹ã‚­ãƒ¼ãƒãŒã©ã†ã„ã†ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨

- `user/{userId}` -> `User`
- `user/{userId}/payment/{paymentId}` -> `Payment`
- `user/{userId}/payment/{paymentId}/paymentLog/{logId}` -> `PaymentLog`

ã¨ã„ã†ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã®é–¢ä¿‚ã‚’è¡¨ã—ã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¹ã®å‹ä»˜ã‘ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã®ã‚¹ã‚­ãƒ¼ãƒã‚’ä¸ãˆã¦ã€firestoreã‚’æ“ä½œã™ã‚‹é–¢æ•°ã‚’å¾—ã¾ã™ã€‚

```ts
import * as fuse from "firefuse";
const collection = fuse.collection<Schema>();
const doc = fuse.doc<Schema>();
const where = fuse.where<User>();
const orderBy = fuse.orderBy<User>();
```

ã“ã‚Œã ã‘ã§ã™ã€‚ä»–ã®è¨­å®šã¯ä¸€åˆ‡è¦ã‚Šã¾ã›ã‚“ã€‚

ã¾ãŸã€ã“ã“ã§ç”Ÿæˆã—ãŸ`collection` `doc`ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«firestore v9ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ã‚‚ã¡ã¾ã™ã€‚

å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã¾ã™

```ts
// const DB = getFirestore();
const paymentColRef = collection(DB, "user", "a", "payment"); // âœ…
const paymentColRef = collection(DB, "not", "exists", "path"); // âŒ:     å‹ '["not", "exists", "path"]' ã‚’å‹ '["user", string, "payment"]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
const paymentDocRef = doc(DB, "user", "a", "payment", "b"); // âœ…
const paymentDocRef = doc(DB, "user", "a", "not", "exists"); // âŒ:   å‹ '["user", "a", "not", "exists"]' ã‚’å‹ '["user", string, "payment", string]' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
```

ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å‚ç…§ã‚’å‹å®‰å…¨ã«ã§ãã¾ã—ãŸã€‚ã“ã‚ŒãŒä¸€ç•ªã®ç›®ç‰ã§ã™ã€‚ä¾‹ãˆã°`user`ã‚’`users`ã®ã‚ˆã†ã«typoã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¦ãã‚Œã¾ã™ã€‚

# ãªã«ãŒä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨é•ã†ã®ã‹

ã“ã‚Œã¾ã§firestoreã‚’æ“ä½œã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æ•°å¤šãå‡ºã¦ãã¾ã—ãŸã€‚ã—ã‹ã—ãã®å¤šãã¯ã€ã‹ã‚†ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šã‹ãªã„ã‚ˆã†ãªã€å¾®å¦™ãªä½¿ã„å‹æ‰‹ã®æ‚ªã•ãŒã‚ã‚Šã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ãªæ™‚ã«ã„ã¡ã„ã¡å…ƒã®firestoreã‚’å¼•ã£å¼µã‚Šå‡ºã—ã¦ãã¦ã€ç„¡ç†ã‚„ã‚Šå®Ÿè£…ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ãŸäº‹ã®ã‚ã‚‹äººã¯å¤šã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã¯ãã®ã‚ˆã†ãªã“ã¨ã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¿°ã¹ãŸã‚ˆã†ã«ã€ãŸã ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã ã‹ã‚‰ã§ã™ã€‚å†…éƒ¨çš„ã«ã¯ã€`collection`ã‚„`doc`ã‚’ãŸã ãƒ©ãƒƒãƒ—ã—ãŸã ã‘ã®å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚ãŸã å‹å®‰å…¨ãªã ã‘ã§ã™ã€‚

# ä»–ã®ä½¿ã„æ–¹

```ts
const userCollection = collection(DB, "user"); // âœ…
doc(userCollection); // âœ…
doc(userCollection, "uid"); // âœ…

const where = fuse.where<User>();
const userCol = collection(DB, "user");
firestore.query(userCol, where("sex", "==", "male")); // âœ…
firestore.query(userCol, where("sex", "==", "no-data")); // âŒ: Argument of type '"no-data"' is not assignable to parameter of type '"male" | "female" | "other"'.
firestore.query(userCol, where("skills", "array-contains", "c")); // âœ…
firestore.query(userCol, where("skills", "array-contains", ["c", "java"])); // âŒ:Argument of type 'string[]' is not assignable to parameter of type 'string'.
firestore.query(userCol, where("skills", "<", "c++")); // âŒ:Argument of type '"<"' is not assignable to parameter of type 'ArrayOp'.
firestore.query(userCol, where("age", "==", 22)); // âœ…
firestore.query(userCol, where("age", "==", "22")); // âŒ: Argument of type 'string' is not assignable to parameter of type 'number'.
firestore.query(userCol, where("age", "array-contains", 22)); // âŒ: Argument of type '"array-contains"' is not assignable to parameter of type 'PrimitiveOp'.

const orderBy = fuse.orderBy<User>();
firestore.query(userCol, orderBy("age")); // âœ…
firestore.query(userCol, orderBy("skills")); // âŒ: Argument of type '"skills"' is not assignable to parameter of type '"age" | "sex" | "birthDay" | "isStudent"'
```

ã¿ã¦ã‚ã‹ã‚‹ã‚ˆã†ã«ã€é…åˆ—ã«`<`ãŒä½¿ãˆãªã‹ã£ãŸã‚Šã€é€†ã«æ–‡å­—åˆ—ã«`array-contains-any`ã‚’æŒ‡å®šå‡ºæ¥ãªã‹ã£ãŸã‚Šã€orderByã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨é…åˆ—ã‚’æŒ‡å®šå‡ºæ¥ãªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚