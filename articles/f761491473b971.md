---
title: "Haskellã®Alexã¨Happyã§node-semverãƒ‘ãƒ¼ã‚µãƒ¼ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ðŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: ture
published_at: 2023-12-04 00:00
---

ã“ã®è¨˜äº‹ã¯[Haskell Advent Calendar 2023](https://qiita.com/advent-calendar/2023/haskell)ï¼”æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ€è¿‘node-semverã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½œã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€Happyã¨Alexã‚’ç”¨ã„ãŸãƒ‘ãƒ¼ã‚µãƒ¼ã®ä½œã‚Šæ–¹ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚ã‚ã¾ã‚Šnode-semverã®ä»•æ§˜ã«ã¯ç«‹ã¡å…¥ã‚‰ãšã€Happyã¨Alexã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

ãƒ‘ãƒ¼ã‚µãƒ¼ã®å®Ÿè£…ã¯ã“ã“ã§ã™ã€‚
https://github.com/Hagihara-A/node-semver-hs


# ãƒ‘ãƒ¼ã‚µã®ç¨®é¡ž

ãƒ‘ãƒ¼ã‚µãƒ¼ã®å®Ÿè£…ã¯ä¸»ã«æ‰‹æ›¸ãã™ã‚‹ã‹æ–‡æ³•æ›¸ã‹ã‚‰ç”Ÿæˆã™ã‚‹ï¼’é€šã‚Šã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚æœ€ã‚‚æœ‰åãªã®ã¯å†å¸°é™ä¸‹æ§‹æ–‡è§£æžã¨ã€LRæ§‹æ–‡è§£æžã§ã—ã‚‡ã†ã‹ã€‚

PEGã‚„ãƒ‘ãƒ¼ã‚µãƒ¼ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ã¯å†å¸°é™ä¸‹ã«å±žã—ã€yaccã‚„bisonã¯LRç³»ã®æ§‹æ–‡è§£æžã«å±žã—ã¾ã™ã€‚

[ã“ã¡ã‚‰ã®ã‚µã‚¤ãƒˆ](https://tratt.net/laurie/blog/2020/which_parsing_approach.html)ã§ã¯æ§˜ã€…ãªæ§‹æ–‡è§£æžæ³•ã®åˆ†æžã‚’ã—ã¦ã„ã¾ã™ã€‚ç®‡æ¡æ›¸ãã§æŠ„è¨³ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

1. å†å¸°é™ä¸‹ç³»
   1. ã‚ã‹ã‚Šã‚„ã™ã„
   2. å®Ÿã¯ã©ã®æ–‡æ³•ã‚¯ãƒ©ã‚¹ã«å¯¾å¿œã™ã‚‹ã‹ç†è«–çš„ã«æ˜Žã‚‰ã‹ã«ãªã£ã¦ã„ãªã„
   3. æ›–æ˜§ãªæ–‡æ³•ã‚’äº‹å‰ã«æ¤œçŸ¥ã§ããªã„
   4. ç„¡é™ã«å…ˆèª­ã¿ãŒã§ãã‚‹ãŸã‚ã€è¨ˆç®—é‡ã®è¦‹ç©ã‚‚ã‚ŠãŒã—ã¥ã‚‰ã„
   5. å·¦çµåˆã®æ¼”ç®—å­ã®ãƒ‘ãƒ¼ã‚¹ãŒç´ ç›´ã«ã§ããªã„
   6. ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ã—ã‚„ã™ã„
2. LRç³»
   1. æ›–æ˜§ãªæ–‡æ³•ã‚’äº‹å‰ã«æ¤œçŸ¥ã§ãã‚‹
   2. å…ˆèª­ã¿ãŒç€¬æ¸›ã•ã‚Œã‚‹ã®ã§ã€è¨ˆç®—é‡ã®è¦‹ç©ã‚‚ã‚ŠãŒã§ãã‚‹(LR(1)ãªã‚‰$O(n)$)
   3. æ–‡è„ˆè‡ªç”±æ–‡æ³•ã®ã†ã¡ã€åºƒã‚ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’å—ç†ã§ãã‚‹
   4. ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ã¯ã‚„ã‚Šã«ãã„
   5. æ¼”ç®—å­ã®å„ªå…ˆåº¦ã‚’è€ƒæ…®ã§ãã‚‹

ã“ã®è¨˜äº‹ã®ç­†è€…ã¯ã€ã€Œå†å¸°é™ä¸‹æ³•ã¯å‹•çš„åž‹ä»˜ã‘è¨€èªžã®ã‚ˆã†ã«ã¨ã£ã¤ãã‚„ã™ã„ãŒå•é¡ŒãŒèµ·ã“ã‚Šã‚„ã™ã„æ‰‹æ³•ã§ã€ LRæ³•ã¯é™çš„åž‹ä»˜ã‘è¨€èªžã®ã‚ˆã†ã«é›£ã—ã„ãŒå•é¡Œã‚’äº‹å‰ã«æ¤œçŸ¥ã—ã‚„ã™ã„æ‰‹æ³•ã ã€ã¨å–©ãˆã¦ã„ã¾ã™ã€‚

Happyã¯LALR(1)ãƒ‘ãƒ¼ã‚µã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã§ã™ã€‚LR(1)ç³»ã®æ§‹æ–‡è§£æžã®ã‚¢ã‚¤ãƒ‡ã‚¢è‡ªä½“ã¯å˜ç´”ã§ã™ã€‚å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å°ºå–ã‚Šè™«ã®ã‚ˆã†ã«ï¼‘ã¤ãšã¤è¦‹ã¦ã„ã£ã¦æœ€çµ‚çš„ã«æ§‹æ–‡æœ¨ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã®æ€§è³ªã®ãŠã‹ã’ã§ã€ç”Ÿæˆã—ãŸãƒ‘ãƒ¼ã‚µãŒ$O(n)$ã§å‹•ãã¨ã„ã†ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚

ã¾ãŸã€ãƒ¬ã‚­ã‚µãƒ¼ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã§ã‚ã‚‹Alexã¨çµ„ã¿åˆã‚ã›ã¦ãƒ‘ãƒ¼ã‚µã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚Alexã¨Happyã¯Haskellè‡ªä½“ã®ãƒ‘ãƒ¼ã‚µã«ã‚‚ä½¿ã‚ã‚Œã¦ã„ã‚‹ãŸã‚å®Ÿç¸¾ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒ¬ã‚­ã‚µãƒ¼ã®ç”Ÿæˆ
Alexã¯`.x`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ–‡æ³•ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ãƒ¬ã‚­ã‚µãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™ã€‚node-semverã®æ–‡æ³•å®šç¾©ã¯ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã®ã§ã€è©³ã—ãã¯ãã“ã‚’è¦‹ã¦ãã ã•ã„ã€‚Alexã«ã¯Wrapperã¨ã„ã£ã¦ã€æ§˜ã€…ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ãƒ¬ã‚­ã‚µãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã®ã§ã™ãŒã€æœ€ã‚‚åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒé‡è¦ã§ã™ã€‚Alexã¯çµå±€ã®ã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã¿ã‚’æä¾›ã—ã¾ã™ã€‚

```haskell
alexScan :: -- Alexã®ç”Ÿæˆã™ã‚‹ãƒ¬ã‚­ã‚µãƒ¼
  AlexInput -> -- ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ä»»æ„ã®å…¥åŠ›
  Int -> -- ãƒ¬ã‚­ã‚µãƒ¼ã®çŠ¶æ…‹ã‚’è¡¨ã™æ•°å­—ã€‚æœ¬è³ªã§ã¯ãªã„
  AlexReturn action -- è¿”ã‚Šå€¤ã€‚actionã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™é–¢æ•°

data AlexReturn action
  = AlexEOF
  | AlexError
      !AlexInput
  | AlexSkip
      !AlexInput
      !Int -- ãƒˆãƒ¼ã‚¯ãƒ³ã®é•·ã•
  | AlexToken
      !AlexInput -- æ®‹ã‚Šã®å…¥åŠ›
      !Int -- ãƒˆãƒ¼ã‚¯ãƒ³ã®é•·ã•
      action
```

alexScanã®åž‹ã‚’è¦‹ã¦ã„ãŸã ã‘ã‚Œã°ã‚ã‹ã‚‹ã®ã§ã™ãŒã€alexScanã¯å…¥åŠ›ã¨çŠ¶æ…‹ã‚’å—ã‘å–ã£ã¦ã€ï¼‘ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘èª­ã¿é€²ã‚ã¾ã™ã€‚ã“ã®APIã‚’ä½¿ã£ã¦ãƒ¢ãƒŠãƒ‰ç‰ˆã®ãƒ‘ãƒ¼ã‚µãƒ¼ãªã©ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ¢ãƒŠãƒ‰ãƒ‘ãƒ¼ã‚µãƒ¼ã«ã¯ä»¥ä¸‹ã®åž‹ãŒä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚

```haskell
import Control.Monad.Trans.State.Strict (StateT)
type Alex a = StateT AlexState (Either String) a
alexMonadScan :: Alex Token -- Alexãƒ¢ãƒŠãƒ‰ã§å®Ÿè¡Œã—ãŸalexScanã®çµæžœã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ãã€‚è¦ã¯Lexerã®çŠ¶æ…‹ã‚’å—ã‘å–ã£ã¦ï¼‘ãƒˆãƒ¼ã‚¯ãƒ³è¿”ã™ã€‚
```

## ãƒ‘ãƒ¼ã‚µãƒ¼ã®ç”Ÿæˆ

happyã¯`.y`æ‹¡å¼µå­ã®æ–‡æ³•å®šç¾©ã‹ã‚‰ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ç”Ÿæˆã—ã¾ã™ã€‚node-semverç”¨ã®æ–‡æ³•å®šç¾©ã‚‚ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ã®ã§è©³ç´°ã¯ãã¡ã‚‰ã‚’ã¿ã¦ãã ã•ã„ã€‚`%monad`ã¨`%lexer`ã‚’è¨­å®šã™ã‚‹ã¨ã€happyã®ç”Ÿæˆã™ã‚‹ãƒ‘ãƒ¼ã‚µãƒ¼ã®åž‹ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```haskell
-- %tokentype { Token }
-- %name parse
-- %error { parseError }
-- %lexer { lexer } { TokenEOF }
-- %monad { Alex } { >>= } { pure }

parse :: Alex t -- tã¯æ§‹æ–‡æœ¨ã®åž‹ã€‚happyãŒç”Ÿæˆã™ã‚‹
parseError :: Token -> Alex a -- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿè£…ã™ã‚‹
lexer :: (Token -> Alex a) -> Alex a -- ãƒ¬ã‚­ã‚µãƒ¼é–¢æ•°ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®Ÿè£…ã™ã‚‹

```

å‹•ä½œãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¥ã‚‰ã„ã¨æ€ã†ã®ã§å°‘ã—è§£èª¬ã—ã¾ã™ã€‚

`parse`ã¯Happyã®ç”Ÿæˆã™ã‚‹æ§‹æ–‡è§£æžå™¨ã§ã™ã€‚Alexã¯åå‰ã‹ã‚‰ã—ã¦å­—å¥è§£æžã®ãŸã‚ã®ãƒ¢ãƒŠãƒ‰ã®å°è±¡ãŒå¼·ã„ã§ã™ãŒã€å®Ÿéš›ã«ã¯ã€Œãƒ‘ãƒ¼ã‚µãƒ¼ã¨ãƒ¬ã‚­ã‚µãƒ¼ã§å¿…è¦ãªã‚‚ã®å…¨èˆ¬ã€ã‚’æ”¾ã‚Šè¾¼ã‚“ã§ãŠããƒ¢ãƒŠãƒ‰ã§ã™ã€‚Alexãƒ¢ãƒŠãƒ‰ã‚’ä½¿ã£ã¦ãƒ¬ã‚­ã‚µãƒ¼ã¨ãƒ‘ãƒ¼ã‚µãƒ¼ã§æƒ…å ±ã‚’ã‚„ã‚Šå–ã‚Šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`parseError`ã¯ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚ä»Šè¦‹ã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ‘ãƒ¼ã‚µãƒ¼ã®çŠ¶æ…‹ã‚’å‚ç…§ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚

`lexer`ã¯ãã®ã¾ã¾ãƒ¬ã‚­ã‚µãƒ¼ã§ã™ãŒã€åž‹ãŒç›´æ„Ÿçš„ã§ã¯ãªã„ã§ã™ã­ã€‚ç¬¬ä¸€å¼•æ•°ã¯"ï¼‘ãƒˆãƒ¼ã‚¯ãƒ³å—ã‘å–ã£ã¦ãã‚Œã‚’æ¶ˆè²»ã™ã‚‹ãƒ‘ãƒ¼ã‚µãƒ¼â€ã§ã™ã€‚ã“ã‚Œã¯happyãŒæ¸¡ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¶ˆè²»ã™ã‚‹éŽç¨‹ã§Lexerã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¦æ–‡è„ˆã«ä¾å­˜ã—ãŸè§£æžãªã©ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚happyã¯çµ‚äº†ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ¸¡ã•ã‚Œã‚‹ã¾ã§ã“ã®`lexer`ã‚’å‘¼ã‚“ã§æ§‹æ–‡è§£æžã‚’è¡Œã„ã¾ã™ã€‚

# ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹

ã¨ã„ã†ã“ã¨ã§ãƒ‘ãƒ¼ã‚µãƒ¼ãŒã§ãã¾ã—ãŸã€‚å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`1.2.3`ãŒ`^1.2.3`ã‚’æº€ãŸã™ã“ã¨ã‚’ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚

```haskell
range = fromRight undefined (parseRange "^1.2.3") -- ^1.2.3 is >=1.2.3 <2.0.0-0
v_123 = version 1 2 3 [] [] 
print (satisfies v_123 range) -- True
```

æœŸå¾…é€šã‚Šã«å‹•ãã¾ã—ãŸã€‚

