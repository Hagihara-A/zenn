---
title: "firestoreã®å‹å®‰å…¨ã‚¯ã‚¨ãƒªãŒã§ããŸ"
emoji: "ğŸ€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["typescript", "firestore"]
published: false
---
ä»¥å‰[è¶…å‹å®‰å…¨firestoreãŒã§ããŸ](https://zenn.dev/arark/articles/0ee7d75dd200db)ã¨è¨€ã£ãŸè€…ãªã‚“ã§ã™ãŒã€ã‚¯ã‚¨ãƒªã‚‚å‹å®‰å…¨ã«ã§ããŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

ä¾‹ãˆã°firestoreã§ã‚¯ã‚¨ãƒªã™ã‚‹ã¨ãã€`where(age, ==, 30)`ã—ãŸã‹ã‚‰typescriptã§ã‚‚`age:30`ã§å‹ã¤ã„ã¦ãã‚“ã­ãˆã‹ãªã€œã€œã€œã€œã€œã€œã€œã€œã€œã€œã£ã¦æ€ã£ãŸã“ã¨ã‚ã‚‹äººäººã„ã¾ã›ã‚“ã‹ã€‚ã“ã‚ŒãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€firestoreç‰¹æœ‰ã®ã‚¯ã‚¨ãƒªã®åˆ¶é™ã€ä¾‹ãˆã°`age > 30`ã¨`height < 150`ã‚’åŒæ™‚ã«ã§ããªã„ã¿ãŸã„ãªãã†ã„ã†ã®ã‚‚æ¤œçŸ¥ã—ã¾ã™ã€‚

# æº–å‚™
```bash
npm i firefuse firebase@9
```

è©³ã—ãã¯[å‰å›ã®è¨˜äº‹](https://zenn.dev/arark/articles/0ee7d75dd200db)ã‹[README](https://github.com/Hagihara-A/fire-fuse)ã‚’èª­ã‚“ã§æ¬²ã—ã„ã‚“ã§ã™ãŒã€ã¨ã‚Šã‚ãˆãšä»¥ä¸‹ã®å‹ã‚’ä½¿ã„ã¾ã™ã€‚

```ts
type User = {
  name: { first: string; last: number; middle?: string };
  age?: number;
  sex?: "male" | "female" | "other";
  birthDay: firestore.Timestamp;
  skills?: string[];
  isStudent: boolean;
};
```

firefuseã®æº–å‚™ã‚’ã—ã¾ã™ã€‚
```ts
const userCol = collection(DB, "user");
const { query } = fuse;
const where = fuse.where<User>();
const orderBy = fuse.orderBy<User>();
```

ã“ã‚Œã§ãŠã—ã¾ã„ã€‚

# ä½¿ç”¨ä¾‹

## å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã¨å€¤ã‚’ã‚¯ã‚¨ãƒªã«ã§ããªã„
```ts
where("age", "==", 22); // âœ…
where("age", "==", "22"); // âŒ: Argument of type 'string' is not assignable to parameter of type 'number'.
where("skills", "array-contains", "c"); // âœ…
where("skills", "array-contains", ["c", "java"]); // âŒ:Argument of type 'string[]' is not assignable to parameter of type 'string'.
orderBy("age"); // âœ…
orderBy("skills"); // âŒ: Argument of type '"skills"' is not assignable to parameter of type '"age" | "sex" | "birthDay" | "isStudent"'
```
ã¾ãã“ã‚Œã¯ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚‚ã‚ˆãã‚ã‚Šã¾ã™ã€‚

## ã‚¯ã‚¨ãƒªã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…ãšå­˜åœ¨ã™ã‚‹
firestoreã®ä»•æ§˜ã¨ã—ã¦ã€ã‚¯ã‚¨ãƒªã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãƒãƒƒãƒã—ãªã„ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€ãƒ’ãƒƒãƒˆã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯å¿…ãšãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¡ã¾ã™ã€‚ã“ã‚Œã‚‚ã§ãã¾ã™ã€‚

```ts
const q1 = query(userCol, where("age", ">", 22)); // âœ…: queried docs are typed to have `.age` property
firestore.getDocs(q1).then((qs) => qs.docs.map((doc) => doc.data().age)); // `.age` became required property!!
```

ä¸Šã®`User`ã®å®šç¾©ã ã¨ã€ageã¯optionalã ã£ãŸã‚“ã§ã™ãŒã€ã“ã®ã‚ˆã†ã«requiredã«ãªã£ã¦ã„ã¾ã™ã€‚

## ä¸æ­£ãªã‚¯ã‚¨ãƒªã‚’æ¤œçŸ¥ã™ã‚‹
å‰è¿°ã—ãŸã‚ˆã†ã«ã€firestoreã«ã¯`!=`ã¨`not-in`ã‚’çµ„ã¿åˆã‚ã›ã‚‰ã‚Œãªã„ã¨ã‹ã€`array-contains`ã¨`array-contains-any`ã‚’çµ„ã¿åˆã‚ã›ã‚‰ã‚Œãªã„ã¨ã‹ã€ã•ã‚‰ã«`in` `not-in` `array-contains-any`ã®ã†ã¡ã²ã¨ã¤ã¾ã§ã—ã‹ä½¿ãˆãªã„ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒå±±ã»ã©ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«å½“ã¦ã¯ã¾ã‚‹ã‚¯ã‚¨ãƒªã‚’ã™ã‚‹ã¨ã€`never`ã§è¿”ã—ã¾ã™ã€‚

```ts
const q2 = query(userCol, where("age", ">", 22), where("sex", "<", "male")); // âŒ: filter on multiple field (firestore's limitation).
firestore.getDocs(q2).then((qs) => qs.docs.map((doc) => doc.data())); // now, doc.data() is never

const q3 = query(
  userCol,
  where("age", ">", 22),
  where("sex", "not-in", ["male"])
); // âŒ: "<", "<=", ">=", ">", "!=" and not-in must filter the same field (firestore's limitation).
firestore.getDocs(q3).then((qs) => qs.docs.map((doc) => doc.data().age)); // doc.data() is never

query(
  userCol,
  where("sex", "in", ["female", "male"]),
  where("age", "not-in", [22, 23]),
  where("skills", "array-contains-any", ["c", "java"])
); // âŒ:  in, not-in or array-contains-any must not be used at the same time and appear only once (firestore's limitation).

query(userCol, where("age", "<", 22), orderBy("age"), orderBy("birthDay")); // âœ…
query(userCol, where("age", ">", 23), orderBy("birthDay")); //âŒ: if you include a filter with a range comparison (<, <=, >, >=), your first ordering must be on the same field: (firestore's limitation)

// use other constraints
const { limit, limitToLast, startAt, startAfter, endAt, endBefore } = fuse;

```

ã“ã‚“ãªæ„Ÿã˜ã§ã™ã­ã€‚ã¡ãªã¿ã«firestoreã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã«ã¯é€šã‚‹ã‘ã©ã€æœ¬ç•ªç’°å¢ƒã ã¨é€šã‚‰ãªã„ã‚¯ã‚¨ãƒªãŒå­˜åœ¨ã™ã‚‹ã‚‰ã—ãã€ãã†ã„ã†ã®ã‚‚äº‹å‰ã«æŠŠæ¡ã§ãã¾ã™ã€‚

## `==`ã‚„`in`, `not-in`ãªã©ã§åˆ¶é™ã—ãŸå€¤ã«å‹ãŒã¤ã
ä¸Šè¿°ã®`User`ã ã¨`sex`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«`male` `female` `other`ã¨ã„ã†ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã—ã¦ç®¡ç†ã—ã¦ãŸã¨ã—ã¾ã™ã€‚ã“ã‚Œã«`where("sex", "!=", "male")`ã‚¯ã‚¨ãƒªã‹ã‘ã¦ã‚‚ã€ç´ ã®firestoreã¯ãã‚ŒãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€å‹ä»˜ã‘ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚`firefuse`ãªã‚‰ã“ã‚Œã‚‚ã§ãã¾ã™ã€‚


```ts
const q4 = query(userCol, where("sex", "!=", "male" as const)); // âœ…: note `as const`
firestore.getDocs(q4).then((qs) => qs.docs.map((doc) => doc.data().sex)); // now, sex is `"female" | "other"` because you removed it !!

const q5 = query(userCol, where("age", "==", 30 as const)); // âœ…: note `as const`
firestore.getDocs(q5).then((qs) => qs.docs.map((doc) => doc.data().age === 30)); // now age === 30, becase you queried!!
```
ã¿ã¦ã®ã‚ˆã†ã«ã€`where(sex, !=, male)`ã™ã‚‹ã¨ã€`sex: "female" | "other"`ã¨æ¨è«–ã—ã¾ã™ã€‚`where(age, ==, 30)`ã«ã™ã‚‹ã¨ã€`age: 30`ã«æ¨è«–ã—ã¾ã™ã€‚


ä»¥ä¸Šã§å…¨ã¦ã§ã™ã€‚`as`ã¨ã‹ã§ã‚­ãƒ£ã‚¹ãƒˆã—ã¦ãŸç—’ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šããƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚å’è«–ã®é€²æ—ã‚’å¤§åˆ†çŠ ç‰²ã«ã—ãŸã®ã§ä½¿ã£ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

