---
title: "Haskellã§ã‚ªãƒ¬ã‚ªãƒ¬Language Serverã‚’æ›¸ã"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["haskell"]
published: false
---

ã“ã®è¨˜äº‹ã§ã¯ Haskell ã‚’ä½¿ã£ã¦ç°¡å˜ãª Language Server(LS)ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ vscode ã®æ‹¡å¼µæ©Ÿèƒ½ã‚‚å®Ÿè£…ã—ã¦å‹•ä½œç¢ºèªã¾ã§è¡Œã„ã¾ã™ã€‚

# Language Server ã®å®Ÿè£…

Haskell ã§ LS ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯[lsp](https://github.com/haskell/lsp)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ã¾ã™ã€‚lsp ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã® 3 ã¤ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚

1. lsp
   - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šå–ã‚Šã‚„Virtual File System(VFS)ãªã©ã®LSã®å®Ÿæ…‹ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚
2. lsp-types
   - Language Server Protocol(LSP)ã§ç”¨ã„ã‚‰ã‚Œã‚‹å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿å‹ã®å®šç¾©ãªã©ã‚’ã—ã¦ã„ã‚‹ã€‚Lensã‚‚åŒæ¢±ã•ã‚Œã¦ã„ã¦å¤§å¤‰ä¾¿åˆ©ã€‚
3. lsp-test
   - LSP ã®ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€‚ä½¿ã£ãŸã“ã¨ãŒãªã„ã®ã§ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚

ã“ã®è¨˜äº‹ã§ã¯ stackage ã®[lts-22.43](https://www.stackage.org/lts-22.43)ã‚’ç”¨ã„ã¾ã™ã€‚lts-22.43ã®lspã¯2.3.0.0ã€lsp-typesã¯2.1.1.0ã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ°—ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚

ã„ããªã‚Šã§ã™ãŒã€LSã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚GitHubã® [lsp/example ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª](https://github.com/haskell/lsp/blob/lsp-2.3.0.0/lsp/example/Simple.hs)ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

```hs
{-# LANGUAGE DuplicateRecordFields #-}
{-# LANGUAGE LambdaCase #-}
{-# LANGUAGE OverloadedStrings #-}

import Control.Monad.IO.Class
import Data.Text qualified as T
import Language.LSP.Protocol.Message
import Language.LSP.Protocol.Types
import Language.LSP.Server

handlers :: Handlers (LspM ())
handlers =
  mconcat
    [ notificationHandler SMethod_Initialized $ \_not -> do
        let params =
              ShowMessageRequestParams
                MessageType_Info
                "Turn on code lenses?"
                (Just [MessageActionItem "Turn on", MessageActionItem "Don't"])
        _ <- sendRequest SMethod_WindowShowMessageRequest params $ \case
          Right (InL (MessageActionItem "Turn on")) -> do
            let regOpts = CodeLensRegistrationOptions (InR Null) Nothing (Just False)

            _ <- registerCapability SMethod_TextDocumentCodeLens regOpts $ \_req responder -> do
              let cmd = Command "Say hello" "lsp-hello-command" Nothing
                  rsp = [CodeLens (mkRange 0 0 0 100) (Just cmd) Nothing]
              responder $ Right $ InL rsp
            pure ()
          Right _ ->
            sendNotification SMethod_WindowShowMessage (ShowMessageParams MessageType_Info "Not turning on code lenses")
          Left err ->
            sendNotification SMethod_WindowShowMessage (ShowMessageParams MessageType_Error $ "Something went wrong!\n" <> T.pack (show err))
        pure ()
    , requestHandler SMethod_TextDocumentHover $ \req responder -> do
        let TRequestMessage _ _ _ (HoverParams _doc pos _workDone) = req
            Position _l _c' = pos
            rsp = Hover (InL ms) (Just range)
            ms = mkMarkdown "Hello world"
            range = Range pos pos
        responder (Right $ InL rsp)
    ]

main :: IO Int
main =
  runServer $
    ServerDefinition
      { parseConfig = const $ const $ Right ()
      , onConfigChange = const $ pure ()
      , defaultConfig = ()
      , configSection = "demo"
      , doInitialize = \env _req -> pure $ Right env
      , staticHandlers = \_caps -> handlers
      , interpretHandler = \env -> Iso (runLspT env) liftIO
      , options = defaultOptions
      }
```

ã“ã®LSã«ã¯2ã¤ã®æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãš1ã¤ã‚ãŒLSãŒèµ·å‹•ã•ã‚ŒãŸã¨ãã« LCã«`Turn on code lenses?`ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã€`Turn on`ãŒé¸æŠã•ã‚Œã‚Œã°CodeLensã‚’æœ‰åŠ¹ã«ã—ã€ãã‚Œä»¥å¤–ãªã‚‰ç„¡åŠ¹ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã¯LSãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã€LCãŒLSã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚

2ã¤ç›®ãŒLCã‹ã‚‰TextHoverãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸæ™‚ã«`Hello world`ã¨ã„ã†å›ºå®šå€¤ã®markdownãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‚‚ã®ã§ã™ã€‚ã“ã‚Œã¯LCèµ·ç‚¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã€LSã¯LCã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚LSPã§ä¸€èˆ¬çš„ã«æƒ³åƒã•ã‚Œã‚‹Completionã‚„Diagnosticsãªã©ã¯ã“ã®å½¢å¼ãªã®ã§ã€é¦´æŸ“ã¿ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## LS ã®ãƒ†ã‚¹ãƒˆ

ä½œã£ãŸ LSã‚’å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã‚’é©å½“ãªãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ã“ã®æ™‚æ”¹è¡Œã‚³ãƒ¼ãƒ‰ãŒ**CRLF**ã«ãªã‚‹ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚vscodeãªã‚‰å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚

```json:test.json-rpc
Content-Length: 162

{
	"jsonrpc": "2.0",
	"id": 1,
	"method": "initialize",
	"params": {
        "processId": 123,
        "rootUri": null,
        "capabilities": {}
	}
}
Content-Length: 54

{
	"jsonrpc": "2.0",
	"id": 2,
	"method": "exit"
}
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`stack run < test.json-rpc`ãªã©ã¨ã—ã¦LSã«ä¸ãˆã‚‹ã¨

```
[Info] Starting server
[Info] LSP: Got exit, exiting
```

ã¨ã„ã†å‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã€LSãŒæ­£å¸¸ã«èµ·å‹•ã¨çµ‚äº†ã‚’ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚åŸç†çš„ã«ã¯ã“ã®ã‚ˆã†ã« LSPã‚’æ‰‹æ›¸ãã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

# Language Client ã®å®Ÿè£…

Language Client(LC)ã¨ã¯ã€LSã¨LSPã§é€šä¿¡ã‚’è¡Œã„ã€å„ã‚¨ãƒ‡ã‚£ã‚¿å‘ã‘ã®è¨€èªæ”¯æ´ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã®ã“ã¨ã§ã™ã€‚vscodeã§ã„ã†ã¨extensionã«ãªã‚Šã¾ã™ã€‚å›³ã«ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```mermaid
graph TB
A[vscode] <-->|vscode API| B["vscode extension(LC)"]
B <-->|LSP| C[languge server]
```

ã¨ã„ã†ã“ã¨ã§ã€vscodeã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚vscodeã§LSPã‚’ç”¨ã„ãŸextensionã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ãŠã‚‚ã«[ã“ã“](https://code.visualstudio.com/api/language-extensions/language-server-extension-guide)ã‚’è¦‹ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
