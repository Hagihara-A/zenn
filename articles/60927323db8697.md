---
title: "firebase v9ã§updateãŒ(å°‘ã—)å‹å®‰å…¨ã«ãªã‚Šã¾ã—ãŸ"
emoji: "ğŸ‡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["firebase", "firestore", "typescript"]
published: true
---
å…ˆæ—¥ã¤ã„ã«firebase v9ãŒ [ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸ](https://firebase.google.com/support/release-notes/js#version_900_-_august_25_2021)

çŸ¥ã£ã¦ã„ã‚‹é™ã‚Šã€v9ã§ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¼(ESM?)ã«ãªã£ãŸã ã‘ã§ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–ä»¥å¤–ã®æ©Ÿèƒ½ã¯ãªã„ã®ã§ã™ãŒã€updateã«é–¢ã—ã¦ã¯å‹å®šç¾©ã§ã®æ›´æ–°ãŒã‚ã£ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

# v9ã®ä½¿ã„æ–¹
å°‘ã—v9ã®ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚v8ã¾ã§ã®ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…ã™ã‚‹ã¨tree shakeã—ã¥ã‚‰ã„ã®ã§ã€å…¨ã¦é–¢æ•°ã«ãªã‚Šã¾ã—ãŸã€‚
```ts
import { initializeApp } from "firebase/app";
const app = initializeApp({ projectId: "..." });
const DB = getFirestore(app);

const userDoc = doc(DB, "user", "userId");
setDoc(userDoc, { hoge: "fuga" });
updateDoc(userDoc, { piyo: "ponyo" });
deleteDoc(userDoc);
getDoc(userDoc);
```

ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã­ã€‚

# updateã§å‹ãŒã¤ã

æœ¬é¡Œã§ã™ã€‚ã“ã‚Œã¾ã˜ã§æ„Ÿå‹•ã—ãŸã‚“ã§ã™ãŒã€updateã§å‹ãŒã¤ãã¾ã™

```ts
type Room = {
  size: number;
  rooms: {
    living: number;
    dining: number;
    kitchen: number;
  };
  level1: {
    level2: { level3: string };
    level2_1: string[];
  };
};
const roomDocRef = doc(DB, "rooms", "roomId") as DocumentReference<Room>;
updateDoc(roomDocRef, { "rooms.living": 123 }); // âœ…
updateDoc(roomDocRef, { "rooms.living": "abc" }); // âŒ å‹ 'string' ã‚’å‹ 'number | FieldValue' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
updateDoc(roomDocRef, { "level1.level2": { level3: "abc" } }); // âœ…
updateDoc(roomDocRef, { "level1.level2": { level3: 123 } }); // âŒ: å‹ 'number' ã‚’å‹ 'string | FieldValue' ã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
updateDoc(roomDocRef, { "level1.level2_1": arrayUnion("asd") }); // âœ…
updateDoc(roomDocRef, { "rooms.living": increment(1) }); // âœ…
```

`DocumentReference`ãŒã¡ã‚ƒã‚“ã¨å‹ä»˜ã‘ã•ã‚Œã¦ã„ã‚‹ã¨ã€ãƒã‚¹ãƒˆã—ãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¾ã§æ¨è«–ã•ã‚Œã¾ã™ã€‚ã‚„ã°ã„ã§ã™ã€‚åœ§å€’çš„ã«å‹å®‰å…¨ã€‚typoã§ä¸€æ—¥ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã“ã¨ãŒç„¡ããªã‚Šã¾ã™ã€‚

ãŸã ã—ã€ã¡ã‚‡ã£ã¨æ®‹å¿µãªã®ãŒã€ä¸‹ã®ä¾‹ã®ã‚ˆã†ãªå ´åˆã§ã™ã€‚

`arrayUnion`ã‚„`increment`ãªã©ã®è¿”ã‚Šå€¤ã¯ä¸€å¾‹ã«`FieldValue`ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œãã‚Œã®åŒºåˆ¥ãŒã¤ãã¾ã›ã‚“ã€‚ãã®ã†ãˆã€`FieldValue`å‹ã¯ã©ã‚“ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚‚æ¸¡ã›ã¾ã™ã€‚ã ã‹ã‚‰ä¾‹ãˆã°é…åˆ—ã«`increment`ã‚’æ¸¡ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ãã‚Œã¨ã€`null`ã‚„`undefined`ã‚‚`FieldValue`æ‰±ã„ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«æ¸¡ã—ã¦ã‚‚å—ã‘å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚ã‚ã¾ã‚Šéä¿¡ã™ã‚‹ã®ã¯å±é™ºã§ã™ã­ã€‚

```ts
updateDoc(roomDocRef, { "level1.level2_1": increment(243) }); // âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
updateDoc(roomDocRef, { "level1.level2_1": serverTimestamp() }); //âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
updateDoc(roomDocRef, { "level1.level2_1": Timestamp.fromDate(new Date()) }); // âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
updateDoc(roomDocRef, { "level1.level2_1": null }); // âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
updateDoc(roomDocRef, { "level1.level2_1": undefined }); // âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
```

ãªãŠã€`batch`ã‚„`runTransaction`ã§ã‚‚åŒã˜ã§ã—ãŸã€‚

# å¤‰ã‚ã‚‰ãªã„ã¨ã“ã‚

queryã‚‚ã‚‚ã—ã‹ã—ãŸã‚‰é€²åŒ–ã—ãŸã‹ã‚‚ï¼ï¼Ÿã¨æ€ã£ãŸã‚‰å¤‰ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§ã‚‚ãªã„ã®ã§ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã§ã™ã€‚
```ts
const roomColRef = collection(
  DB,
  "rooms",
  "roomId"
) as CollectionReference<Room>;

const q = query(
  roomColRef,
  where("hogehoge", "==", "piyopiyo"), âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
  orderBy("fuga") âœ… ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
); 
```


